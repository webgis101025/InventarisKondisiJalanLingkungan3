<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventaris Kondisi Jalan Lingkungan</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Measure -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"/>

  <!-- Search -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    :root{
      --nav:#0b3556;         /* biru tua ala USGS */
      --nav2:#08304d;
      --bg:#f2f4f7;
      --panel:#ffffff;
      --panel2:#f7f9fc;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#d6dde8;
      --shadow: 0 10px 24px rgba(0,0,0,0.15);
      --radius: 8px;
      --accent:#2563eb;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:var(--bg); }

    /* ====== Layout ala USGS ====== */
    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Header */
    .header{
      height:64px;
      background: linear-gradient(0deg, var(--nav2), var(--nav));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 16px;
      box-shadow: var(--shadow);
      z-index: 9999;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:700;
      letter-spacing:.3px;
    }
    .brand .logo{
      width:38px;height:38px;
      border-radius:6px;
      background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:var(--nav);
      font-weight:900;
      font-size:14px;
    }
    .brand .title{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brand .title small{
      font-weight:400;
      opacity:.9;
    }

    .navlinks{
      display:flex;
      gap:16px;
      font-size:13px;
      opacity:.95;
    }
    .navlinks a{
      color:#fff; text-decoration:none;
    }
    .navlinks a:hover{ text-decoration:underline; }

    /* Main area */
    .main{
      flex:1;
      display:flex;
      min-height:0;
    }

    /* Sidebar */
    .sidebar{
      width:360px;
      background:var(--panel);
      border-right:1px solid var(--border);
      padding:12px;
      overflow:auto;
    }

    .tabs{
      display:flex;
      gap:6px;
      border-bottom:1px solid var(--border);
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border:1px solid var(--border);
      border-bottom:none;
      background:var(--panel2);
      border-top-left-radius:6px;
      border-top-right-radius:6px;
      font-size:13px;
      color:var(--muted);
    }
    .tab.active{
      background:#fff;
      color:var(--text);
      font-weight:700;
    }

    .section{
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      margin-bottom:12px;
      background:#fff;
    }
    .section .section-h{
      background:var(--panel2);
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-weight:700;
      font-size:13px;
      color:var(--text);
    }
    .section .section-b{
      padding:10px 12px;
      font-size:13px;
      color:var(--text);
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .btnrow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }

    .field{
      margin-top:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .field input, .field select{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:6px;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }

    .smallnote{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }

    /* Map container */
    .mapwrap{
      flex:1;
      min-width:0;
      position:relative;
    }
    #map{
      position:absolute;
      inset:0;
    }

    /* Popup image */
    .popup-img{
      width: 100%;
      max-width: 280px;
      border-radius: 8px;
      margin-top: 6px;
      display: block;
      border:1px solid rgba(0,0,0,0.08);
    }

    /* Legend */
    .legend{
      background: #fff;
      padding: 10px 12px;
      font-size: 12px;
      line-height: 18px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.25);
      max-height: 260px;
      overflow: auto;
      border:1px solid rgba(0,0,0,0.12);
    }
    .legend i{
      width: 28px;
      height: 4px;
      float: left;
      margin: 7px 8px 0 0;
      border-radius:999px;
    }

    /* Label desa (klik tembus) */
    .desa-label{
      font-family: Arial, Helvetica, sans-serif;
      font-weight: 700;
      font-size: 13px;
      color: #1f2937;
      text-align: center;
      white-space: nowrap;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 6px 16px rgba(0,0,0,0.10);
      pointer-events: none;
    }

    /* Responsive: sidebar jadi collapsible sederhana */
    @media (max-width: 900px){
      .sidebar{ width: 320px; }
    }
    @media (max-width: 720px){
      .sidebar{ display:none; }
      .header{ height:56px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Header ala USGS -->
    <div class="header">
      <div class="brand">
        <div class="logo">GIS</div>
        <div class="title">
          <div>Inventaris Jalan Lingkungan</div>
          <small>WebGIS Desa</small>
        </div>
      </div>
      <div class="navlinks">
        <a href="#" onclick="return false;">Help</a>
        <a href="#" onclick="return false;">Feedback</a>
        <a href="#" onclick="return false;">Login</a>
      </div>
    </div>

    <!-- Main -->
    <div class="main">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="tabs">
          <div class="tab active">Search Criteria</div>
          <div class="tab">Data Sets</div>
          <div class="tab">Additional</div>
          <div class="tab">Results</div>
        </div>

        <div class="section">
          <div class="section-h">1. Enter Search Criteria</div>
          <div class="section-b">
            <div class="hint">
              Gunakan panel ini untuk membantu navigasi peta:
              <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted);">
                <li><b>Home</b> untuk kembali ke tampilan awal</li>
                <li><b>Search</b> untuk mencari lokasi</li>
                <li><b>Measure</b> untuk mengukur jarak/luas</li>
                <li>Klik garis jalan untuk melihat <b>popup</b> dan <b>foto</b></li>
              </ul>
            </div>

            <div class="btnrow">
              <button class="btn primary" id="btnHome" type="button">Home View</button>
              <button class="btn" id="btnZoomData" type="button">Zoom Data</button>
            </div>

            <div class="field">
              <label>Koordinat pusat (Lat, Lon)</label>
              <input id="coordInput" type="text" value="0.6226, 117.2870" />
              <div class="smallnote">Format: <b>lat, lon</b> (contoh: 0.6226, 117.2870)</div>
            </div>

            <div class="field">
              <label>Zoom</label>
              <select id="zoomSelect">
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11" selected>11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
              </select>
            </div>

            <div class="btnrow">
              <button class="btn" id="btnGo" type="button">Go</button>
              <button class="btn" id="btnClear" type="button">Clear</button>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-h">Summary</div>
          <div class="section-b">
            <div class="hint">
              Layer:
              <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted);">
                <li>Garis jalan (No_1–No_72)</li>
                <li>Batas desa (outline merah)</li>
                <li>Label nama desa</li>
                <li>Legenda blok (A–O)</li>
              </ul>
            </div>
          </div>
        </div>
      </aside>

      <!-- Map -->
      <div class="mapwrap">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // =========================
    // SCRIPT KAMU (LOGIKA UTAMA TETAP)
    // =========================

    // 1) SETTING ZOOM AWAL
    const INITIAL_CENTER = [0.6226, 117.2870];
    const INITIAL_ZOOM = 11;

    const map = L.map("map", { preferCanvas: true }).setView(INITIAL_CENTER, INITIAL_ZOOM);

    // Basemap ESRI
    const esriImagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20 }
    ).addTo(map);

    // OSM (opsional)
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 20 }
    );

    // Switch basemap (tanpa ubah logika layer jalan)
    L.control.layers(
      { "ESRI Imagery": esriImagery, "OpenStreetMap": osm },
      null,
      { position: "topright", collapsed: true }
    ).addTo(map);

    // 2) PANE
    map.createPane("batasPane");
    map.getPane("batasPane").style.zIndex = 350;

    map.createPane("jalanPane");
    map.getPane("jalanPane").style.zIndex = 450;

    map.createPane("labelPane");
    map.getPane("labelPane").style.zIndex = 500;

    // 3) WARNA BLOK
    function warnaBlok(blok){
      switch(blok){
        case "A": return "#e41a1c";
        case "B": return "#377eb8";
        case "C": return "#4daf4a";
        case "D": return "#ff7f00";
        case "E": return "#984ea3";
        case "F": return "#bbffcc";
        case "G": return "#dd00ff";
        case "H": return "#2e0e33";
        case "I": return "#71e3f7";
        case "J": return "#686323";
        case "K": return "#eeff00";
        case "L": return "#8f2f3f";
        case "M": return "#4d4d4d";
        case "N": return "#ffffff";
        case "O": return "#000000";
        default:  return "#ff0000";
      }
    }

    // 4) POPUP JALAN
    function popupHTML(p){
      const klas =
        p["Klasifikasi Jalan"] ??
        p.Klasifikasi_Jalan ??
        p.KLASIFIKASI ??
        "JALAN LINGKUNGAN";

      return `
        <b>Informasi Jalan</b><br><br>
        No : ${p.No ?? "-"}<br>
        Nama Desa : ${p["Nama Desa"] ?? p.Nama_Desa ?? "-"}<br>
        Blok : ${p.Blok ?? "-"}<br>
        Panjang : ${p.Panjang ?? "-"}<br>
        Lebar : ${p.Lebar ?? "-"}<br>
        Kondisi : ${p.Kondisi ?? "-"}<br>
        Klasifikasi Jalan : ${klas}<br>
        <hr>
        <b>Foto:</b><br>
        <img src="FOTO/${p.FOTO ?? ""}" class="popup-img" onerror="this.style.display='none'">
      `;
    }

    // 5) LOAD JALAN (No_1 – No_72)
    for(let i=1;i<=72;i++){
      fetch(`data/No_${i}.geojson`)
        .then(r => r.json())
        .then(data => {
          L.geoJSON(data,{
            pane: "jalanPane",
            interactive: true,
            style: f => ({
              color: warnaBlok(f.properties?.Blok),
              weight: 4
            }),
            onEachFeature:(f,l)=>{
              l.bindPopup(popupHTML(f.properties || {}));
            }
          }).addTo(map);
        })
        .catch(() => {});
    }

    // 6) BATAS DESA OUTLINE MERAH + LABEL
    function getNamaDesa(props){
      return (
        props["Nama Desa"] ||
        props["NAMA_DESA"] ||
        props["DESA"] ||
        props["nama_desa"] ||
        props["NAMOBJ"] ||
        "Desa"
      );
    }

    fetch("data/Batas_Desa.geojson")
      .then(r => r.json())
      .then(data => {
        const batasLayer = L.geoJSON(data,{
          pane: "batasPane",
          interactive: false,
          style:{
            color:"#ff0000",
            weight:2,
            fill:false
          }
        }).addTo(map);

        batasLayer.eachLayer(layer => {
          if(!layer.feature || !layer.feature.properties) return;

          const nama = getNamaDesa(layer.feature.properties);
          const center = layer.getBounds().getCenter();

          const icon = L.divIcon({
            className: "",
            html: `<div class="desa-label">${nama}</div>`,
            iconSize: [0, 0]
          });

          L.marker(center, {
            pane: "labelPane",
            icon,
            interactive: false,
            keyboard: false
          }).addTo(map);
        });
      })
      .catch(() => {
        console.warn("Batas_Desa.geojson tidak ditemukan. Pastikan file ada di folder data/");
      });

    // 7) MEASURE TOOL
    L.control.measure({
      position: "topleft",
      primaryLengthUnit: "meters",
      secondaryLengthUnit: "kilometers",
      primaryAreaUnit: "sqmeters",
      secondaryAreaUnit: "hectares"
    }).addTo(map);

    // 8) SEARCH LOKASI
    L.Control.geocoder({
      position: "topright",
      defaultMarkGeocode: true
    }).addTo(map);

    // 9) LEGENDA BLOK (GARIS)
    const legend = L.control({position:"bottomright"});
    legend.onAdd = function(){
      const div = L.DomUtil.create("div","legend");
      div.innerHTML += "<b>Legenda Blok</b><br>";

      const blok = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O"];
      blok.forEach(b=>{
        div.innerHTML += `<i style="background:${warnaBlok(b)}"></i> Blok ${b}<br>`;
      });

      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);

      return div;
    };
    legend.addTo(map);

    // =========================
    // UI SIDEBAR (TAMBAHAN, TANPA MENGUBAH LOGIKA UTAMA)
    // =========================
    const btnHome = document.getElementById("btnHome");
    const btnZoomData = document.getElementById("btnZoomData");
    const btnGo = document.getElementById("btnGo");
    const btnClear = document.getElementById("btnClear");
    const coordInput = document.getElementById("coordInput");
    const zoomSelect = document.getElementById("zoomSelect");

    btnHome.addEventListener("click", () => {
      map.setView(INITIAL_CENTER, INITIAL_ZOOM, { animate: true });
      coordInput.value = `${INITIAL_CENTER[0]}, ${INITIAL_CENTER[1]}`;
      zoomSelect.value = String(INITIAL_ZOOM);
    });

    btnGo.addEventListener("click", () => {
      const raw = coordInput.value.trim();
      const parts = raw.split(",").map(s => s.trim());
      if(parts.length !== 2) return;

      const lat = parseFloat(parts[0]);
      const lon = parseFloat(parts[1]);
      const z = parseInt(zoomSelect.value, 10);

      if(Number.isFinite(lat) && Number.isFinite(lon) && Number.isFinite(z)){
        map.setView([lat, lon], z, { animate: true });
      }
    });

    btnClear.addEventListener("click", () => {
      coordInput.value = "";
      zoomSelect.value = String(INITIAL_ZOOM);
    });

    // Zoom Data: coba zoom ke batas desa kalau ada, kalau belum ada tetap home
    btnZoomData.addEventListener("click", () => {
      fetch("data/Batas_Desa.geojson")
        .then(r => r.json())
        .then(gj => {
          const tmp = L.geoJSON(gj);
          const b = tmp.getBounds();
          if(b && b.isValid()){
            map.fitBounds(b, { padding:[20,20] });
          }else{
            map.setView(INITIAL_CENTER, INITIAL_ZOOM);
          }
        })
        .catch(() => map.setView(INITIAL_CENTER, INITIAL_ZOOM));
    });

  </script>
</body>
</html>
